# تحليل تفصيلي لتطبيق حجز الفنادق باستخدام Supabase

## نظرة عامة على النظام

التطبيق عبارة عن نظام حجز فنادق باستخدام Supabase كباك إند. Supabase هو بديل مفتوح المصدر لـ Firebase، يوفر قاعدة بيانات PostgreSQL وخدمات المصادقة وتخزين الملفات والوظائف السحابية.

## قاعدة البيانات

من ملف SQL نلاحظ أن النظام يستخدم الجداول التالية:

1. **users**: بيانات المستخدمين (مرتبط بجدول auth.users)
2. **hotels**: معلومات الفنادق
3. **rooms**: تفاصيل الغرف المتاحة في كل فندق
4. **bookings**: تسجيل الحجوزات للمستخدمين
5. **reviews**: تقييمات المستخدمين للفنادق

## هيكل العلاقات بين الجداول

- **users ↔ auth.users**: علاقة واحد لواحد، حيث يتم ربط بيانات المستخدم الأساسية بنظام المصادقة
- **hotels ↔ rooms**: علاقة واحد لكثير، فندق واحد يمكن أن يحتوي على عدة غرف
- **users ↔ bookings**: علاقة واحد لكثير، مستخدم واحد يمكنه إجراء عدة حجوزات
- **rooms ↔ bookings**: علاقة واحد لكثير، غرفة واحدة يمكن حجزها في أوقات مختلفة
- **users ↔ reviews**: علاقة واحد لكثير، مستخدم واحد يمكنه كتابة عدة تقييمات
- **hotels ↔ reviews**: علاقة واحد لكثير، فندق واحد يمكن أن يتلقى عدة تقييمات

## خدمة الـ Supabase

من خلال الملف `supabase.service.ts` يمكننا فهم خدمات الباك إند:

### 1. المصادقة (Authentication)

الخدمة توفر:
- **تسجيل الدخول**: باستخدام البريد الإلكتروني وكلمة المرور
- **إنشاء حساب**: تسجيل مستخدم جديد
- **تسجيل الخروج**: إنهاء جلسة المستخدم


```typescript
// تسجيل الدخول
async signIn(email: string, password: string) {
  // التواصل مع Supabase للتحقق من بيانات المستخدم
}

// إنشاء حساب
async signUp(email: string, password: string, name: string) {
  // التواصل مع Supabase لإنشاء حساب جديد
}

// تسجيل الخروج
async signOut() {
  await this.supabase.auth.signOut();
  this.currentUser.next(null);
}
```

### 2. خدمات الفنادق

- **جلب جميع الفنادق**: مع حساب متوسط التقييم وعدد الغرف
- **جلب فندق محدد**: بالمعرف الخاص به

```typescript
async getHotels() {
  // جلب بيانات الفنادق مع التقييمات والغرف
  const { data, error } = await this.supabase
    .from('hotels')
    .select(`
      *,
      rooms (count),
      reviews (rating)
    `)
    .order('name');
  
  // حساب متوسط التقييم لكل فندق
  const hotelsWithRating = data?.map(hotel => ({
    ...hotel,
    average_rating: hotel.reviews?.length 
      ? hotel.reviews.reduce((acc: number, review: any) => acc + review.rating, 0) / hotel.reviews.length 
      : 0,
    rooms_count: hotel.rooms?.[0]?.count || 0
  }));
}
```

### 3. خدمات الغرف

- **جلب غرف فندق محدد**: لعرض الغرف المتاحة للحجز

```typescript
async getRoomsByHotelId(hotelId: string) {
  return await this.supabase
    .from('rooms')
    .select('*')
    .eq('hotel_id', hotelId);
}
```

### 4. خدمات الحجوزات

- **إنشاء حجز**: للمستخدم المسجل
- **جلب حجوزات المستخدم**: لعرض تاريخ حجوزات المستخدم
- **تحديث حالة الحجز**: (مؤكد، ملغي، مكتمل)
- **تحديث حالة الدفع**: (معلق، مدفوع، مسترد، فاشل)

```typescript
async createBooking(bookingData: {
  room_id: string;
  check_in: string;
  check_out: string;
  total_price: number;
}) {
  const user = await this.getCurrentUser();
  if (!user.data.user) throw new Error('User not authenticated');

  return await this.supabase
    .from('bookings')
    .insert({
      user_id: user.data.user.id,
      room_id: bookingData.room_id,
      check_in: bookingData.check_in,
      check_out: bookingData.check_out,
      total_price: bookingData.total_price,
      status: 'pending',
      payment_status: 'pending'
    });
}
```

### 5. خدمات التقييمات

- **إنشاء تقييم**: للمستخدم المسجل
- **جلب تقييمات فندق**: لعرض آراء المستخدمين

```typescript
async createReview(reviewData: {
  hotel_id: string;
  rating: number;
  comment: string;
}) {
  const user = await this.getCurrentUser();
  if (!user.data.user) throw new Error('User not authenticated');

  return await this.supabase
    .from('reviews')
    .insert({
      user_id: user.data.user.id,
      hotel_id: reviewData.hotel_id,
      rating: reviewData.rating,
      comment: reviewData.comment
    });
}
```

## آلية عمل الباك إند بالتفصيل

### 1. اتصال التطبيق بـ Supabase

يتم إنشاء اتصال بمجرد تشغيل التطبيق:

```typescript
constructor() {
  console.log('Initializing Supabase client with URL:', this.supabaseUrl);
  this.supabase = createClient(this.supabaseUrl, this.supabaseKey);
  this.loadCurrentUser();
}
```

### 2. تدفق المصادقة

1. **تسجيل الدخول**:
   - إرسال البريد الإلكتروني وكلمة المرور إلى Supabase
   - التحقق من صحة البيانات
   - إذا كانت صحيحة، يتم تخزين بيانات المستخدم في `currentUser`
   - استخدام `Promise.race` مع timeout لتجنب تجميد التطبيق في حالة عدم الاستجابة

2. **إنشاء حساب**:
   - إرسال البريد الإلكتروني وكلمة المرور والاسم
   - إضافة مستخدم جديد في جدول `auth.users`
   - تشغيل الـ Trigger `on_auth_user_created` لإضافة المستخدم للجدول `users`
   - تخزين معلومات اسم المستخدم في options.data

3. **تسجيل الخروج**:
   - مسح بيانات المصادقة المخزنة محلياً
   - تعيين `currentUser` إلى null

4. **تحميل بيانات المستخدم الحالي**:
   - التحقق من وجود جلسة نشطة
   - استخراج بيانات المستخدم وتخزينها في `currentUser`

### 3. تدفق عمليات الفندق

1. **عرض الفنادق**:
   - جلب البيانات من جدول `hotels`
   - استخدام استعلام متداخل لجلب عدد الغرف والتقييمات
   - حساب متوسط التقييم لكل فندق
   - ترتيب النتائج حسب الاسم

2. **عرض تفاصيل فندق**:
   - جلب بيانات الفندق بواسطة المعرف
   - استخدام .single() للحصول على نتيجة واحدة فقط

### 4. تدفق عملية الحجز

1. **إنشاء حجز**:
   - التحقق من تسجيل دخول المستخدم
   - جمع بيانات الحجز (معرف الغرفة، تاريخ الوصول، تاريخ المغادرة، السعر الإجمالي)
   - إضافة سجل جديد في جدول `bookings`
   - تعيين حالة الحجز كـ "معلق"
   - تعيين حالة الدفع كـ "معلق"

2. **عرض حجوزات المستخدم**:
   - التحقق من تسجيل دخول المستخدم
   - جلب حجوزات المستخدم من جدول `bookings`
   - استخدام استعلام متداخل لجلب تفاصيل الغرف والفنادق المرتبطة

3. **تحديث حالة الحجز**:
   - تغيير حالة الحجز (مؤكد، ملغي، مكتمل)
   - تحديث السجل في قاعدة البيانات عن طريق معرف الحجز

4. **تحديث حالة الدفع**:
   - تغيير حالة الدفع (مدفوع، مسترد، فاشل)
   - تحديث السجل في قاعدة البيانات عن طريق معرف الحجز

### 5. تدفق عملية التقييم

1. **إضافة تقييم**:
   - التحقق من تسجيل دخول المستخدم
   - جمع بيانات التقييم (معرف الفندق، التقييم من 1-5، التعليق)
   - إضافة سجل جديد في جدول `reviews`

2. **عرض تقييمات فندق**:
   - جلب جميع تقييمات الفندق المحدد
   - استخدام استعلام متداخل لجلب أسماء المستخدمين

## مزايا استخدام Supabase كباك إند

1. **المصادقة الجاهزة**: توفير نظام مصادقة جاهز للاستخدام دون الحاجة إلى تطويره من الصفر.

2. **قاعدة بيانات علائقية**: استخدام PostgreSQL يوفر مرونة في تصميم قاعدة البيانات والاستعلامات.

3. **RLS (Row Level Security)**: يمكن تطبيق سياسات الأمان على مستوى الصفوف لضمان عدم وصول المستخدمين إلى بيانات غيرهم.

4. **API تلقائية**: توفير واجهة برمجة تلقائية (RESTful) لجميع الجداول والاستعلامات.

5. **الاشتراكات في الوقت الفعلي**: إمكانية استخدام الاشتراكات لتحديث واجهة المستخدم في الوقت الفعلي.

## مميزات تصميم الباك إند

1. **استخدام BehaviorSubject للمستخدم**: يسمح للمكونات المختلفة بالاشتراك والتفاعل مع حالة المستخدم الحالي.

2. **معالجة الأخطاء**: الكود يتضمن معالجة استباقية للأخطاء مع timeout للطلبات لتجنب تجميد التطبيق.

3. **التحقق من المصادقة**: قبل تنفيذ أي عملية خاصة، يتم التحقق من حالة تسجيل الدخول.

4. **استخدام الاستعلامات المتداخلة**: لجلب البيانات المرتبطة في طلب واحد، مما يقلل من عدد الطلبات للخادم.

5. **قيود قاعدة البيانات**: التحقق من صحة البيانات على مستوى قاعدة البيانات (مثل التواريخ الصحيحة، حالات الحجز، نطاق التقييم).

## القيود والتحقق من الصحة في قاعدة البيانات

1. **التحقق من التواريخ**: ضمان أن تاريخ المغادرة بعد تاريخ الوصول
   ```sql
   ADD CONSTRAINT valid_dates CHECK (check_in < check_out);
   ```

2. **التحقق من حالة الحجز والدفع**: ضمان استخدام القيم المسموح بها فقط
   ```sql
   ADD CONSTRAINT valid_status CHECK (status IN ('pending', 'confirmed', 'cancelled', 'completed'));
   ADD CONSTRAINT valid_payment_status CHECK (payment_status IN ('pending', 'paid', 'refunded', 'failed'));
   ```

3. **التحقق من التقييم**: ضمان أن التقييم بين 1 و 5
   ```sql
   rating INTEGER CHECK (rating >= 1 AND rating <= 5)
   ```

4. **التحقق من الأسعار**: ضمان أن الأسعار موجبة
   ```sql
   ADD CONSTRAINT valid_price CHECK (price_per_night > 0);
   ```

## فهرسة قاعدة البيانات لتحسين الأداء

تم إنشاء فهارس لتسريع الاستعلامات الشائعة:

```sql
CREATE INDEX idx_hotels_location ON hotels(location);
CREATE INDEX idx_bookings_dates ON bookings(check_in, check_out);
CREATE INDEX idx_rooms_hotel_availability ON rooms(hotel_id, is_available);
CREATE INDEX idx_reviews_hotel ON reviews(hotel_id);
```

هذه الفهارس تساعد في:
- تسريع البحث عن الفنادق حسب الموقع
- تسريع التحقق من توفر الغرف في تواريخ معينة
- تسريع جلب الغرف المتاحة لفندق معين
- تسريع جلب تقييمات فندق محدد

## هيكل التطبيق بشكل عام

1. **الواجهة (Frontend)**: 
   - تطبيق Angular يستخدم خدمة Supabase.
   - مكونات لعرض الفنادق، تفاصيل الفندق، حجز غرفة، وإدارة الحجوزات.

2. **قاعدة البيانات (Database)**:
   - قاعدة بيانات PostgreSQL تستضيفها Supabase.
   - تتضمن جداول المستخدمين، الفنادق، الغرف، الحجوزات، والتقييمات.
   - قيود وعلاقات لضمان سلامة البيانات.

3. **المصادقة (Authentication)**:
   - خدمة مصادقة Supabase تتعامل مع تسجيل الدخول/الخروج، إنشاء الحسابات، والجلسات.
   - ربط المستخدمين في نظام المصادقة مع جدول المستخدمين في التطبيق.

4. **خدمة Supabase (Service)**:
   - طبقة وسيطة تتعامل مع الباك إند.
   - توفر واجهة برمجة مبسطة للمكونات للتفاعل مع قاعدة البيانات.
   - تتعامل مع إدارة الجلسات وحالة المستخدم عبر التطبيق.

## ملخص الوظائف الرئيسية للتطبيق

1. **تصفح الفنادق**: عرض قائمة الفنادق مع التقييمات وعدد الغرف.
2. **عرض تفاصيل الفندق**: عرض معلومات الفندق والغرف المتاحة والتقييمات.
4. **حجز غرفة**: اختيار الغرفة وتواريخ الإقامة وإنشاء حجز.
5. **إدارة الحجوزات**: عرض وإلغاء وإكمال الحجوزات.
6. **تقييم الفنادق**: إضافة تقييم وتعليق للفنادق.
7. **إدارة الدفع**: تحديث حالة الدفع للحجوزات.

هذا التطبيق يمثل نموذجاً جيداً لاستخدام Supabase في تطوير تطبيقات الويب الحديثة، مع الاستفادة من مزايا قواعد البيانات العلائقية وأنظمة المصادقة الجاهزة.
